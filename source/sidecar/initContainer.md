# 初期化コンテナ

初期化コンテナはサイドカーパターンの類型と考えられます。
サイドカーパターンは、起動するとコンテナの横にずっと居座る形になりますが、初期化コンテナは、コンテナが起動する前に動く形式となっており、初期化が完了すると、そのコンテナは終了します。
あくまで初期化用という位置づけになっています。

## 初期化コンテナの例

たとえば、Webサーバーで考えてみましょう。
Webサーバーでは、クライアントに返すコンテンツが必要ですが、いちいちコンテンツを作成する毎にイメージ化していると、更新が頻繁になってしまいますし、イメージのサイズが増えてしまうこともあります。

そこで、イメージにはコンテンツを加えずに作成し(提供基盤のみ、たとえばWebサーバー部分のみ)、初期化コンテナからコンテンツを書き込むという方法を取ることができます。

1. 初期化コンテナを起動する
2. 初期化コンテナがコンテンツを書き込む
   - どこから?
     - 社内の専用ファイルサーバーから
     - GitHub(Enterprise)から
     - 別途マウントされたストレージから  etc
3. 初期化コンテナを終了する
4. メインのコンテナ(Webサーバー)を起動する

この際に、両者が同じボリュームを共有した状態にしておくことで、初期化コンテナが書き込んだ内容がそのままメインコンテナで参照可能となります。

```{literalinclude} src/web+loader.yml
:language: yaml
:linenos:
:emphasize-lines: 27-35
```

- 初期化コンテナは、`initContainer`という`containers`とは別の枠組みで規定します
  - 書き方自体は`containers`と同じです
- ボリューム(ここではweb-content)を用意し、初期化コンテナとメインコンテナで共有します

```{note}
なお今回の初期化コンテナでは、瞬間的にファイル配置が終わってしまうため、検証目的で{command}`sleep`を差し込んでウェイトをかけています。
もちろん実際の運用では不要です。
```

このマニフェストを適用し、Podの状態をすぐにトレースしてみましょう。

```pwsh
PS> kubectl apply -f web+loader.yml; kubectl get pods -w
deployment.apps/web-loader created
NAME                          READY   STATUS     RESTARTS   AGE
web-loader-545c4fb658-7w85l   0/1     Init:0/1   0          0s
web-loader-545c4fb658-7w85l   0/1     Init:0/1   0          4s
web-loader-545c4fb658-7w85l   0/1     PodInitializing   0          14s
web-loader-545c4fb658-7w85l   1/1     Running           0          15s
```

と、ステータスの表記がこれまでのものと少し変わっていることがわかります。

- Readyが0/2からはじまらず、0/1からはじまっています
  - 初期化コンテナは処理後に消滅するため、Readyのカウントには含まれていません
- STATUSが`Init:0/1`となっている
  - 初期化コンテナが実行中であることを示しています
  - `Init:0/1`が`Init:1/1`になることはまずありません
    - 初期化コンテナが処理を終えると終了するためです
  - 初期化コンテナの処理が終了すると、`PodInitializing`になります、その後`Running`となります

初期化コンテナが作業している間は、メインコンテナは起動しません。

では、無事コンテナが起動しているかを確認するため、ポートフォワードを使ってアクセスしてみましょう。

```pwsh
PS> kubectl port-forward deploy/web-loader 8080:80
# 別ターミナルで実行
PS> curl localhost:8080
Hello, World!
```

`Hello, World!`と表示されれば成功です。

## まとめ

初期化コンテナを使うと、コンテナの初期化処理を分離することができます。
メインコンテナが起動する前に、初期化コンテナが必要な処理を行い、その結果をメインコンテナに引き継ぐことができます。
この仕組みにより、コンテナの再利用性を高める(ひとつのイメージを使い回しやすくなる)ことができます。
