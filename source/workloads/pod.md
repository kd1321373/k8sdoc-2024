# ポッドリソース(Pod)

ポッド(Pod)はKubernetesの基本的なリソースで、コンテナを実行するための環境を提供します。
ポッドは1つ以上のコンテナをまとめて管理するためのリソースであり、コンテナの実行環境を提供します。

## ポッドの作成

ポッドを作成するには、マニフェストファイルを使って`kubectl apply`コマンドを実行します。
あらためて、`pod/hello-world`のマニフェストを見てみましょう。

```{literalinclude} sources/pod-hw.yml
:lineos:
```

ポッドは、apiVersion v1の仕様を使って生成しています。
`spec`以下は、ポッドとして作成するコンテナの『仕様(specification)』を記述しています。

## ポッドとコンテナ

ここまで、ポッドとコンテナをほぼ同義のようにしていましたが、あくまでポッドは概念で、その実装としてのコンテナという立ち位置になります。

```{figure} images/pod.drawio.png
:align: center

ポッドの概念、中にコンテナがある
```

ポッドは内包するコンテナを管理する役割を持ち、もし管理しているコンテナが終了した場合は、ポッドがコンテナを再生成します。
もちろんこのとき消滅する前のコンテナと復帰したコンテナは別物です。

```{figure} images/pod-recover.drawio.png
:align: center

ポッドがコンテナを再生成
```

## ポッドの仕様とパラメータ

ポッドの仕様について、簡単な部分のみ解説しておきます。

`name`
: ポッド内のコンテナ名、ポッド内でユニークである必要があります

`image`
: コンテナの使うイメージ名

`resources`
: コンテナが必要とするリソースの指定、実は書かなくても良いのですが、描いておかないとvscodeのK8s拡張が文句を言います(無制限に使える可能性があるので、正しいといえば正しい)、メモリとCPU利用量(1秒あたりの許容ミリ秒単位)

`env`
: 環境変数を使いたい場合は、`name`/`value`のセットでリストを作ることで指定可能です

## 複数のコンテナを持つポッド

ポッドは中に複数のコンテナを持たせることができます。
この場合、コンテナは必ず同一ノード上で動作し、暗黙でネットワークやストレージを共有します。
ホスト名としてポッドの名前を使うことができます。

以下のサンプルはMySQLとphpMyAdminを同居させたポッドの記述になります。

```{literalinclude} sources/pod-phpmyadmin-with-mysql.yml
:linenos:
:emphasize-lines: 11-25,27-42
```

spec.containers以下でリスト構造として2つのコンテナを記述することで、2つのコンテナの入ったポッドという仕様にしています。

## おまけ: ポッドへのブラウザアクセス

phpMyAdminが動いている以上、ブラウザでアクセスできないと悲しいですよね。
Kubernetesでは、ポッドに対して直接アクセスすることはできませんが、ポートフォワーディングを使うことでローカルからアクセスすることができます。

```{figure} ./images/port-forward.drawio.png
:align: center

ポートフォワードの概念
```

```bash
$ kubectl port-forward pod/db-with-ui 8080:80
```

これで、localhost上の8080番ポートでアクセス可能です。
http://localhost:8080/ にアクセスするとphpMyAdminが表示されるはずです。

```{note}
- MySQL側が起動に少し時間がかかるため、タイミングが早いと失敗します(要リロード)
- ブラウザ側のキャッシュが出る可能性もあります(要リロード)
```


## 最後に

このセクションで作成したポッドリソースは、きちんと消しておきましょう。
