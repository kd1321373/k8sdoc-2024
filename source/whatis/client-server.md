# クライアント・サーバー構成について

K8sでは、いわゆるクライアント・サーバー構成で構築されています。

- 制御する側(クライアント)
  - `kubectl`コマンドなどを用いてサーバーに指示を出す
  - 逆に情報を返してもらうこともある
- 制御される側(サーバー)
  - K8sクラスター全体を管理する
  - マスターとノード(ワーカー)に分かれている

# K8sクラスターについて

K8sクラスターは、マスターとノード(ワーカー)で構成されています。

- マスターはクライアントからの指示を受け付けます、この際はJSONの形式でやりとりが発生しています
- ノードはマスターからの指示を受けて、コンテナを起動したり停止したりします
- ノードは中で動いているコンテナなどのリソースを管理し、不意に死んだりしたときに再起動するなどの仕事を行います

```{figure} ./images/cluster.png
大雑把なクラスタ・サーバー構成で構築
```


# ノードについて

ノードは実際にコンテナを走らせる場所で、マスターからの指示により動作します。
ただしノードにはマスターからの指示を受け取るためのプログラムが待機しており、適宜ノードの持つリソース(メモリやストレージなど)をマスターに報告しています。
マスターはノードの状況を見て、適当にコンテナ制御の指示を出すようになっています。
ノードはマスターからの指示により、コンテナの稼働状況を適宜確認し、必要ならコンテナの再起動などを行います。

```{figure} ./images/node.png
ノードについて
```

- ノードにはコンテナ(ポッド)を制御するためのコントローラーが潜んでおり、Control-Plainからのリクエストに対して処理を指示していきます
  - Podはコンテナを抽象化したもので、コンテナを内包していきます(ただし内包するものはコンテナのみとは限りません)
  - 通常はコンテナは1つ内包しますが、必要に応じて2つ以上内包したり、起動時にだけ複数コンテナが内包されることあります
    - 初期化用コンテナ
    - readiness probe/lively probe
- ノード内ではコンテナ用(ポッド用)のネットワークが用意されており、ポッドは同一ノード内でのポッド(に入っているコンテナ)との通信が可能です
- いわゆるオーバーレイ構造にもなっており、連携するポッドが別ノードに移動していたとしても通信できるようにもなります
- ポッドの検出は、主にDNSをベースとしたサービスディスカバリ手法が用意されます
